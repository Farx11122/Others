local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local HttpService = game:GetService("HttpService")
local lp = Players.LocalPlayer

local WEBHOOK_URL = "https://discord.com/api/webhooks/1417218030672416889/16_w64_aNdyV1p_P8Iqrnzw8L0JZiXGnLtjHSJEUPEPTo94-fnme5cc-ecD3E9-Ma2un"
local cfg = {UpdateInterval = 10, MinValue = 9500000}
local lastUp = 0
local sentAnimals = {}

local function parseVal(s)
    if not s or type(s) ~= "string" then return 0 end
    local cl = s:gsub("%$", ""):gsub("/s", ""):gsub("/S", ""):lower()
    local m = {k = 1e3, m = 1e6, b = 1e9, t = 1e12, q = 1e15}
    local n, su = cl:match("([%d%.]+)([kmbtq]?)")
    n = tonumber(n) or 0
    if su and m[su] then n = n * m[su] end
    return n
end

local function getDispName()
    return lp.DisplayName
end

local function isMyPlot(p)
    local s, sg = pcall(function() return p:FindFirstChild("PlotSign") end)
    if not s or not sg then return false end
    local s2, lb = pcall(function() return sg.SurfaceGui.Frame.TextLabel end)
    if not s2 or not lb then return false end
    local t = lb.Text or ""
    local n = getDispName()
    return string.find(t:lower(), n:lower()) ~= nil
end

local function findAnims(p)
    local a = {}
    local function srch(o)
        for _, c in pairs(o:GetChildren()) do
            if c.Name == "AnimalPodiums" then
                for _, pd in pairs(c:GetChildren()) do
                    local s, d = pcall(function()
                        local bs = pd:FindFirstChild("Base")
                        local sp = bs and bs:FindFirstChild("Spawn")
                        local at = sp and sp:FindFirstChild("Attachment")
                        local oh = at and at:FindFirstChild("AnimalOverhead")
                        local dp = oh and oh:FindFirstChild("DisplayName")
                        local gn = oh and oh:FindFirstChild("Generation")
                        if dp and gn then
                            return {
                                displayName = dp.Text, 
                                generation = gn.Text, 
                                position = sp.Position, 
                                object = sp,
                                value = parseVal(gn.Text)
                            }
                        end
                    end)
                    if s and d then table.insert(a, d) end
                end
            else srch(c) end
        end
    end
    srch(p)
    return a
end

local function sendToWebhook(animals)
    if not WEBHOOK_URL or WEBHOOK_URL == "https://discord.com/api/webhooks/1417218030672416889/16_w64_aNdyV1p_P8Iqrnzw8L0JZiXGnLtjHSJEUPEPTo94-fnme5cc-ecD3E9-Ma2un" then
        return
    end
    
    local jobId = game.JobId
    local embeds = {}
    
    for _, animal in pairs(animals) do
        local embed = {
            ["title"] = " i Found!",
            ["color"] = 65280,
            ["fields"] = {
                {
                    ["name"] = "Animal Name",
                    ["value"] = animal.displayName,
                    ["inline"] = true
                },
                {
                    ["name"] = "Value",
                    ["value"] = tostring(animal.value),
                    ["inline"] = true
                },
                {
                    ["name"] = "Job ID",
                    ["value"] = jobId,
                    ["inline"] = true
                }
            },
            ["footer"] = {
                ["text"] = "Animal found"
            },
            ["timestamp"] = DateTime.now():ToIsoDate()
        }
        
        table.insert(embeds, embed)
    end
    
    local data = {
        ["embeds"] = embeds,
        ["username"] = "Brainrot Finder"
    }
    
    local success, result = pcall(function()
        local jsonData = HttpService:JSONEncode(data)
        
        if syn and syn.request then
            syn.request({
                Url = WEBHOOK_URL,
                Method = "POST",
                Headers = {
                    ["Content-Type"] = "application/json"
                },
                Body = jsonData
            })
        elseif fluxus and fluxus.request then
            fluxus.request({
                Url = WEBHOOK_URL,
                Method = "POST",
                Headers = {
                    ["Content-Type"] = "application/json"
                },
                Body = jsonData
            })
        elseif request then
            request({
                Url = WEBHOOK_URL,
                Method = "POST",
                Headers = {
                    ["Content-Type"] = "application/json"
                },
                Body = jsonData
            })
        elseif http_request then
            http_request({
                Url = WEBHOOK_URL,
                Method = "POST",
                Headers = {
                    ["Content-Type"] = "application/json"
                },
                Body = jsonData
            })
        else
            HttpService:PostAsync(WEBHOOK_URL, jsonData)
        end
    end)
    
    if success then
        print("Webhook sent: " .. #animals .. " animals")
    else
        print("Webhook error: " .. tostring(result))
    end
end

local function findValuableAnimals()
    local valuableAnimals = {}
    local plts = Workspace:FindFirstChild("Plots")
    if not plts then return valuableAnimals end
    
    for _, p in pairs(plts:GetChildren()) do
        if not isMyPlot(p) then
            local anims = findAnims(p)
            for _, a in pairs(anims) do
                if a.value >= cfg.MinValue then
                    local animalKey = a.displayName .. "_" .. tostring(a.value)
                    if not sentAnimals[animalKey] then
                        table.insert(valuableAnimals, a)
                        sentAnimals[animalKey] = true
                        print("Found: " .. a.displayName .. " - " .. tostring(a.value))
                    end
                end
            end
        end
    end
    
    return valuableAnimals
end

local function upd()
    local n = tick()
    if n - lastUp < cfg.UpdateInterval then return end
    lastUp = n
    
    local valuableAnimals = findValuableAnimals()
    
    if #valuableAnimals > 0 then
        sendToWebhook(valuableAnimals)
    end
end

local function main()
    print(" started")
    upd()
    RunService.Heartbeat:Connect(upd)
end

main()
